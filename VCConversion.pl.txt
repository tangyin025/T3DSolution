#!/usr/bin/perl -w
use strict;

# #############################################################################
#
# STEP:
# 1) remove all _vc8.vcporj and _vc8.sln
# 2) find all .vcproj and .sln, but not _vc8.vcporj and _vc8.sln
# 3) copy it to .vcproj and .sln to _vc8.vcporj and _vc8.sln
#    but, specially, for .sln, it should replace the string ".vcproj" to "_vc8.vcproj"
# 4) open *_vc8.sln with with VC2005, the convert wizard will appear
#
# #############################################################################

sub _ASSERT ($$@)
{
	my $path = shift @_;
	my $line = shift @_;
	
	foreach my $expr (@_)
	{
		if(! $expr )
		{
			die "$path ($line) : assert failured! \n";
		}
	}
}

sub _71vcproj_to_80vcproj ($)
{
	my $path = $_[0];
_ASSERT(__FILE__, __LINE__, ( $path =~ m/.+\.vcproj$/ && ! ($path =~ m/^.+_vc8\.vcproj$/) ));
	open(SRC, $path) || die "cannot open $path: $!";
	$path =~ s/^(.+)\.vcproj$/$1_vc8.vcproj/;
	open(DST, ">" . $path) || die "cannot open $path: $!";
	print DST <SRC>;
	close(DST);
	close(SRC);

	print STDOUT "+ $path \n";
	return $path;
}

sub _71sln_to_80sln ($)
{
	my $path = $_[0];
_ASSERT(__FILE__, __LINE__, ( $path =~ m/.+\.sln$/ && ! ($path =~ m/^.+_vc8\.sln$/) ));
	open(SRC, $path) || die "cannot open $path: $!";
	$path =~ s/^(.+)\.sln$/$1_vc8.sln/;
	open(DST, ">" . $path) || die "cannot open $path: $!";
	while(my $line = <SRC>)
	{
		$line =~ s/\.vcproj/_vc8.vcproj/;
		print DST $line;
	}
	close(DST);
	close(SRC);

	print STDOUT "+ $path \n";
	return $path;
}

sub convert_file ($)
{
	my $path = $_[0];
	if(! (-d $path) )
	{
		if($path =~ m/.+\.vcproj$/)
		{
			if(! ($path =~ m/.+_vc8\.vcproj$/) )
			{
				$path = _71vcproj_to_80vcproj($path);
			}
		}
		elsif($path =~ m/.+\.sln$/)
		{
			if(! ($path =~ m/.+_vc8\.sln$/) )
			{
				$path = _71sln_to_80sln($path);
			}
		}
	}
}

sub delete_old_file ($)
{
	my $path = $_[0];
	if(! (-d $path) )
	{
		if(
			$path =~ m/.+_vc8\.ncb$/ ||
			$path =~ m/.+_vc8\.suo$/ ||
			$path =~ m/.+_vc8\.sln$/ ||
			$path =~ m/.+_vc8\.vcproj$/ ||
			$path =~ m/.+_vc8\.vcproj\..+$/ ||
			$path =~ m/UpgradeLog\d*\.XML$/i
			)
		{
			if(unlink $path)
			{
				print STDOUT "- $path \n";
			}
			else
			{
				print STDOUT "failed delete $path: $! \n";
			}
		}
	}
	else
	{
		if(
			$path =~ m/.+_UpgradeReport_Files/i
			)
		{
			unlink glob "$path/*";
			
			if( rmdir $path )
			{
				print STDOUT "- $path \n";
			}
			else
			{
				print STDOUT "failed delete $path: $! \n";
			}
		}
	}
}

sub iterate_dir ($$)
{
	my $dir = $_[0];
	my $sub = $_[1];

	opendir(DIR, $dir) || die "cannot open $dir: $!";
	my @cons = readdir DIR;
	closedir(DIR);
	
	foreach my $elem (@cons)
	{
		if(!($elem =~ m/^\..*/))
		{
			my $path = $dir . "/" . $elem;

			if(-d $path)
			{
				&iterate_dir($path, $sub);
			}

			&$sub($path);
		}
	}
}

iterate_dir(".", \&delete_old_file);

iterate_dir(".", \&convert_file);

print STDOUT "VCConversion succeed \n";
